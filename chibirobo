#!/usr/bin/env bash

set -m

if [[ -e /etc/profile.env ]]; then
    source /etc/profile.env
fi

declare -r TAB=$'\t'
declare -r CSI=$'\e['
declare -r FG=3
declare -r YELLOW=3
declare -r CYAN=6
declare -r BOLD=1
declare -r UNDERLINE=4
declare -r TITLE="${CSI}${BOLD};${UNDERLINE};${FG}${CYAN}m"
declare -r DATUM="${CSI}${BOLD};${FG}${YELLOW}m"
declare -r NORM="${CSI}m"
declare -r ICON_OK="✅"
declare -r ICON_WARN="⚠️"
declare -r ICON_ERR="❌"
declare -r ICON_INFO="ℹ️"
declare -r ICON_NEW="🎁"
declare -r ICON_ROBOT="🤖"
declare -r ICON_CLEAN=$'\xf0\x9f\xa7\xb9'
declare -r ICON_WAIT="⏳"
declare -r BULLET="•"

style() {
    echo "$*$NORM"
}

oops() {
    (( ++errors )) || :
}

journal() {
    local icon=

    while [[ $# -gt 0 ]]; do
        case "$1" in
        --icon)
            shift
            icon="$1"
            shift
            ;;
        *)
            break
        esac
    done

    style "${icon}${icon:+ }${TITLE}$*"
    echo
    cat
    echo
}

journalled() {
    local icon="$ICON_OK" title stdout stderr ret
    stdout="$(mktemp --tmpdir="$tmpdir")"
    stderr="$(mktemp --tmpdir="$tmpdir")"

    while [[ $# -gt 0 ]]; do
        case "$1" in
        --icon)
            shift
            icon="$1"
            shift
            ;;
        *)
            break
        esac
    done

    title="$1"
    shift

    "$@" >"$stdout" 2>"$stderr"
    ret="$?"

    (( ret )) && icon="$ICON_ERR"

    {
        if (( ret )); then
            oops
            echo "This command failed with code $(style "$DATUM$ret"):"
            echo
            echo "$TAB$*"
            echo
            echo "Standard output was:"
            echo
            sed 's/^/\t/' < "$stdout" 
            echo
            echo "Standard error was:"
            echo
            sed 's/^/\t/' < "$stderr"
        elif [[ -s "$stdout" ]]; then
            cat "$stdout"
        fi
    } | journal --icon "$icon" "$title"

    rm "$stdout" "$stderr"

    return "$ret"
}

email() {

    subject="$1"

    if [[ -n "$verbose" ]]; then
        echo "$subject"
        echo
        cat
        return
    fi

    {
        echo "From: $recipients"
        echo "Subject: $ICON_ROBOT $HOSTNAME: $subject" 
        echo "Content-Type: text/html; charset=utf-8"
        echo
        {
            cat
            echo
            echo '-- '
            echo "Mail generated by $myname"
            echo 'Exterminate! Exterminate!'
        } | ansi2html -a
    } | sendmail "$recipients"
}

cleanup() {
    for j in $(jobs -p); do
        kill -INT -- -"$j"
    done
    wait
    for i in emerge{,-fetch}.log; do
        if [ -f "$tmpdir/$i" ]; then
            cat < "$tmpdir/$i" >> /var/log/"$i"
        fi
    done
    [ -f "$tmpdir"/.chibirobo ] && rm -rf "$tmpdir"
}

do-sync() {
    emaint sync -A > /dev/null || return $?
    eix-diff > "$tmpdir"/eix-diff.txt

    if [[ -s $tmpdir/eix-diff.txt ]]; then
        {
            echo "These installed packages got updated by the Gentoo maintainers:"
            echo
            cat "$tmpdir"/eix-diff.txt
        } | email "$ICON_NEW Repository updates!"
    fi
}

do-emerge() {
    emerge --color n --keep-going -qvuDN --with-bdeps=y --accept-properties=-interactive --accept-restrict=-fetch @world \
    >/dev/null
}

installed-size() {
    equery -q size -b \* \
    | sed 's/.*size(\([0-9]\+\))/\1/' \
    | awk 'BEGIN{x=0}{x+=$0}END{print x}' \
    | numfmt --to=iec-i --format=%fB
}

update-kernel() {
    command update-kernel "$@" >/dev/null
}

eclean-distfiles() {
    command eclean -d distfiles -f "$@" | tail -n 10
}

revdep-rebuild() {
    command revdep-rebuild -- --keep-going -q > /dev/null
}

is-network-up() {
    [[ $(nmcli network connectivity check) == full ]]
}

wait-for-network() {
    local retries=6
    sleep 10
    until is-network-up; do
        sleep 10
        if (( --retries == 0 )); then
            echo "Network didn't come up in time!" >&2
            return 1
        fi
    done
}

inhibit-suspend() {
    local -a uids
    mapfile -t uids < <(systemctl show user@\*.service -P UID|grep -Fxv '')
    for i in "${uids[@]}"; do
        local name bus="/run/user/$i/bus"
        if ! [[ -S $bus ]]; then
            continue
        fi
        name="$(getent passwd "$i"|cut -d: -f1)"
        env -i DBUS_SESSION_BUS_ADDRESS=unix:path="$bus" \
        sudo --preserve-env=DBUS_SESSION_BUS_ADDRESS \
             --user="$name" \
             gnome-session-inhibit --inhibit suspend --inhibit-only --reason "Chibirobo is doing some cleaning..." >/dev/null &
    done
}

verbose=
nosync=

while [ $# -gt 0 ]; do
    opt="$1"
    shift
    case "$opt" in
    -v|--verbose)
        verbose=1;;
    --nosync)
        nosync=1;;
    esac
done

myname="$0"
recipients=alex.iris.parker@gmail.com
tmpdir="$(mktemp -d)" || exit 1
errorlog="$tmpdir/stderr.txt"
errors=0
badnews=

trap cleanup 0

chown portage:portage "$tmpdir"
chmod 770 "$tmpdir"

export HOME=~portage
rootbin=~root/bin
export PATH="$rootbin:$PATH"
export FORCE_COLORS=true
export FEATURES=-candy
export EMERGE_LOG_DIR="$tmpdir"
export DIFF_FORMAT_NEW=
export DIFF_FORMAT_DELETE=
export DIFF_ONLY_INSTALLED=true

touch "$tmpdir/.chibirobo" || exit 1

{
    equery l -F "\$cpv" @module-rebuild | \
        tail -n +1 > "$tmpdir"/dracut-packages.txt
} &
equery_job=$!

exec 2>"$errorlog"

if [ -z "$verbose" ]; then
    exec 1>"$tmpdir/journal.txt"
else
    tail -f "$errorlog" >&2 &
fi

main() {
    inhibit-suspend

    if ! is-network-up; then
        journalled --icon "$ICON_WAIT" "Wait for the network to come up" wait-for-network
    fi

    if [ -z "$nosync" ]; then
        if ! journalled "Synchronize the repositories" do-sync; then
            badnews="Failed to synchronize!"
            return
        fi
    fi

    if ! journalled "Update @world" do-emerge; then
        badnews="Failed to update @world!"
        return
    fi

    if ! journalled "Ensure linking consistency" revdep-rebuild; then
        badnews="Failed to ensure linking consistency!"
        return
    fi

    grep -F ') Merging (' "$tmpdir"/emerge.log | awk -v FS='[():]' '{print $5}' > "$tmpdir"/merged.txt
    declare -a merged
    mapfile -t merged < "$tmpdir"/merged.txt

    if [[ ${#merged[@]} -gt 0 ]]; then
        {
            while read -r line; do
                echo "${TAB}${BULLET} $(style "${DATUM}$line")"
            done < "$tmpdir"/merged.txt
        } | journal --icon "$ICON_INFO" "I merged these packages:"
    fi

    wait "$equery_job"

    if ! update-kernel --check; then
        local nv
        nv="$(update-kernel --newest)"
        if journalled "Update to Linux kernel $nv." update-kernel; then
            journalled --icon "$ICON_CLEAN" "Clean old kernels." eclean-kernel -n 3
        fi
    elif grep -qFf "$tmpdir"/dracut-packages.txt < "$tmpdir"/merged.txt; then
        journalled "Update the initial ram disk." dracut --force
    fi

    : | needrestart -qnrl | grep -Fv 'systemctl restart user@' > "$tmpdir"/needrestart.txt

    if [[ -s "$tmpdir"/needrestart.txt ]]; then
        sed 's/^/\t/' < "$tmpdir"/needrestart.txt \
        | journal --icon "$ICON_WARN" "These services need to be restarted:"
    fi

    journalled --icon "$ICON_CLEAN" "Clean the distfiles" eclean-distfiles

    echo "Goodbye!" \
    | journal --icon "$ICON_INFO" "Total installed package size is now: ${CSI}${FG}${YELLOW}m$(installed-size)"
}

main

if [[ -z $verbose ]]; then
    if [[ -n $badnews ]]; then
        subj="$ICON_ERR ${badnews}"
    elif (( errors == 0 )); then
        subj="$ICON_OK Chibirobo ran successfully"
    else
        subj="$ICON_WARN Chibirobo ran with errors"
    fi
    email "$subj" < "$tmpdir"/journal.txt
fi
